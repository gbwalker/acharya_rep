---
title: "Replication: The Political Legacy of American Slavery"
output:
  pdf_document:
    md_extension: +raw_tex
bibliography: citations.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(foreign)
library(plyr)
library(reshape)
library(sandwich)
library(maps)
library(stargazer)
library(AER)
library(Formula)
library(lme4)
library(cem)
library(latticeExtra)
library(stringr)
library(bookdown)

# A library with custom functions.

source("data/panel-utils.R")

# Two more custom functions.
# http://people.su.se/~ma/clustering.pdf

robust.se <- function(fm, clvar){
    # R-codes (www.r-project.org) for computing
    # clustered-standard errors. Mahmood Arai, Jan 26, 2008.
    # The arguments of the function are:
    # fitted model, cluster1 and cluster2
    # You need to install libraries `sandwich' and `lmtest'
  library(sandwich);library(lmtest);
  x <- eval(fm$call$data, envir = parent.frame())
  if ("polr" %in% class(fm)) {
    require(MASS)
    cluster <- x[rownames(predict(fm, type = "probs")), clvar]
  } else {
    cluster <- x[names(predict(fm)), clvar]
  }
  M <- length(unique(cluster))
  N <- length(cluster)
  K <- dim(vcov(fm))[1]
  dfc <- (M/(M-1))*((N-1)/(N-K))
  uj  <- apply(estfun(fm),2, function(x) tapply(x, cluster, sum));
  vcovCL <- dfc*sandwich(fm, meat=crossprod(uj)/N)
  coeftest(fm, vcovCL)
}

ch.row <- function(name, yesno) {
    c(name, ifelse(yesno, "$\\checkmark$", ""))
}

# Federal Information Processing codes for states.

data(state.fips)
state.fips <- unique(state.fips[,c("fips","abb")])
state.fips$abb <- as.character(state.fips$abb)
state.fips <- rbind(state.fips, c(2, "AK"))
state.fips <- rbind(state.fips, c(15, "HI"))
rownames(state.fips) <- state.fips$abb
fips.state <- state.fips
rownames(fips.state) <- fips.state$fips

# FIPs for counties.

data(county.fips)

# Custom colors.

dodgerblue.30 <- rgb(30, 144, 255, 76.5, max =255)
indianred.30 <- rgb(205, 92, 92, 76.5, max =255)
indianred.75 <- rgb(205, 92, 92, 191, max =255)
```

\begin{flushright}
Gabe Walker

March 6, 2019
\end{flushright}

### Abstract

I partially replicate "The Political Legacy of American Slavery" by @acharya from @data. The main regression results (Tables 1-3) appear as in the original paper. Some of the figures either cannot be replicated without further guidance (Fig. 1), take too long to knit (Fig. 3), or require additional data (Fig. 6). I include more detailed comments about the statistical methods the authors used in the comments of this file.


```{r data, echo=FALSE, message=FALSE, warning=FALSE, error = FALSE, cache = TRUE}
### Work with the initial data.

## Read in three datasets.

# CCES is the Cooperative Congressional Election Study. The researchers used pooled data from 2006 to 2011
# and subset it to include whites from 1,329 southern counties.
# NES is the National Election Survey. The researchers used 1984-1998 black/white thermometer scores from
# 3,123 individuals in 64 southern counties.

# The first is county-level data with no CCES or NES data merged.
# The second is county-level data with aggregated white CCES responses merged.
# The third is individual-level CCES data with county variables merged.

# N.B. the third csv is not included on Github due to file size constraints.
# Instead, download it here: https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/CAEEG7

countydata <- read.csv("data/abs-jop-countydata.csv", stringsAsFactors = FALSE)
wh.counties <- read.csv("data/abs-jop-cces-white-countydata.csv", stringsAsFactors = FALSE)
cces.comb <- read.csv("data/abs-jop-cces-ind.csv", stringsAsFactors = FALSE)

# Make a list of only the states of interest.

st.list <- c("AL", "AR", "GA", "FL", "KY", "LA", "MS", "MO", "NC", "SC", "TN", "TX", "VA","WV")

# This "subsets" the three datasets listed above by making a new dummy variable
# if the state is in the state list. An awful way to subset.

cces.comb$abs.sample <- 1 * (cces.comb$state.abb %in% st.list)
wh.counties$abs.sample <- 1 * (wh.counties$state.abb %in% st.list)
countydata$abs.sample <- 1 * (countydata$state.abb %in% st.list)

# This calculates the tractor growth per county-acre from 1930 to 1940.

wh.counties$tractor.growth <- (wh.counties$tractors40 - wh.counties$tractors30)

# This creates an income category in the survey results (cces.comb) and
# subsets of the survey data by race.

cces.comb$inc.cat <- factor(cces.comb$inc.cat, levels = c("<20k", "20-50k", "50-100k", "100-150k", "150k+"))
whites <- cces.comb[which(cces.comb$white == 1),]
blacks <- cces.comb[which(cces.comb$black == 1),]
latinos <- cces.comb[which(cces.comb$latino == 1),]
others <- cces.comb[which(cces.comb$white != 1 & cces.comb$black != 1 & cces.comb$latino != 1),]

# This creates a subset of survey results by race for the states of interest,
# using the dummy created above (abs.sample).

southerners <- subset(cces.comb, abs.sample == 1)
s.whites <- subset(whites, abs.sample == 1)
s.blacks <- subset(blacks, abs.sample == 1)
s.latinos <- subset(latinos, abs.sample == 1)
s.whites$state.abb <- factor(s.whites$state.abb)
s.blacks$state.abb <- factor(s.blacks$state.abb)
s.latinos$state.abb <- factor(s.latinos$state.abb)

# This creates a subset of survey data from southern counties.

south.counties <- subset(wh.counties, abs.sample == 1)
south.counties$state.abb <- factor(south.counties$state.abb)
south.counties <- south.counties[order(as.numeric(south.counties$fips)),]

# Read in county-level data with aggregated white NES responses merged.
# Read in individual-level NES data with county variables merged.

nes.counties <- read.csv("data/abs-jop-nes-white-countydata.csv", stringsAsFactors = FALSE)
nes.comb <- read.csv("data/abs-jop-nes-ind.csv", stringsAsFactors = FALSE)

# Make a dummy variable for states of interest.

nes.counties$abs.sample <- 1 * (nes.counties$state.abb %in% st.list)
nes.comb$abs.sample <- 1 * (nes.comb$state.abb %in% st.list)

# Make subset groups for whites and blacks.

nes.whites <- nes.comb[which(nes.comb$white == 1),]
nes.blacks <- nes.comb[which(nes.comb$black == 1),]

# Make ANOTHER subset of whites and blacks from the southern states of interest.
# Hashtag too many dataframes floating around.

ns.whites <- subset(nes.whites, abs.sample == 1)
ns.blacks <- subset(nes.blacks, abs.sample == 1)

# Factor the state names to make sure they're not strings.

ns.whites$state.abb <- factor(ns.whites$state.abb)
ns.blacks$state.abb <- factor(ns.blacks$state.abb)
```

```{r regressions1, echo=FALSE, message=FALSE, warning=FALSE, error = FALSE}
### Set up some formulas.

# Formulas with many, many parameters.

base1860.form <- formula(. ~ pslave1860 + log(coarea00) + latitude + I(latitude^2) + longitude + I(longitude^2)+ rugged  + land.ineq1860 + sfarmprop1860 + log(totpop1860) + log(fvalpac1860) + log(acimp1860) + fbprop1860  + rail1860 + water1860 + state.abb)

ind.form <- formula(. ~ pslave1860 + log(coarea00) + latitude + I(latitude^2) + longitude + I(longitude^2) + rugged + land.ineq1860 + sfarmprop1860 + log(totpop1860) + log(fvalpac1860) + log(acimp1860) + fbprop1860 + rail1860 + water1860 + as.factor(educ) +  inc.cat +religion + female + age + state.abb*as.factor(year))

ind.int.form <- formula(. ~ pslave1860   + log(coarea00) + latitude + I(latitude^2) + longitude + I(longitude^2) + rugged + land.ineq1860 + sfarmprop1860 + log(totpop1860) + log(fvalpac1860) + log(acimp1860) + fbprop1860 + rail1860 + water1860 + as.factor(educ)*pslave1860 + inc.cat*pslave1860 + religion*pslave1860 + female*pslave1860 + age*pslave1860  + state.abb*as.factor(year))

context.form <- formula(. ~ pslave1860   + log(coarea00) + latitude + I(latitude^2) + longitude + I(longitude^2) + rugged + land.ineq1860 + sfarmprop1860 + log(totpop1860) + log(fvalpac1860) + log(acimp1860) + fbprop1860 + rail1860 + water1860 + as.factor(educ) + inc.cat  +religion +female + age + blkprop.z00 + log(medinc.z10) + w.unemp.rate2014 + log(wbincratio2014) + state.abb*as.factor(year))

context.int.form <- formula(. ~ pslave1860   + log(coarea00) + latitude + I(latitude^2) + longitude + I(longitude^2) + rugged + land.ineq1860 + sfarmprop1860 + log(totpop1860) + log(fvalpac1860) + log(acimp1860) + fbprop1860 + rail1860 + water1860 + as.factor(educ) +  inc.cat  +religion +female + age + blkprop.z00*pslave1860 + log(medinc.z10)*pslave1860 + w.unemp.rate2014*pslave1860 + log(wbincratio2014)*pslave1860 + state.abb*as.factor(year))

base.iv.form <- Formula(. ~ pslave1860 + log(coarea00) + rugged + latitude + I(latitude^2) + longitude + I(longitude^2)  + water1860  + state.abb | cottonsuit + log(coarea00) + rugged  + latitude + I(latitude^2) + longitude + I(longitude^2) + water1860  + state.abb)

base.first.form <- formula(pslave1860 ~ cottonsuit + log(coarea00) + rugged + latitude + I(latitude^2) + longitude + I(longitude^2)  +water1860 + state.abb)

rform.form <- formula(. ~  cottonsuit + log(coarea00) + rugged + latitude + I(latitude^2)+ longitude + I(longitude^2)  + water1860+  state.abb)

```

### Figure 1. Estimated proportion slave in 1860 by county.

This figure is missing a necessary dataframe (counties2000) with no explanation about where it came from.

```{r echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, eval = FALSE}
library(raster)
library(rgdal)
library(rgeos)
library(plyr)
library(reshape)
library(ineq)
library(maps)
library(maptools)
library(foreign)
library(RColorBrewer)
library(classInt)

data(state.fips)
state.fips <- unique(state.fips[,c("fips","abb")])
state.fips$abb <- as.character(state.fips$abb)
state.fips <- rbind(state.fips, c(2, "AK"))
state.fips <- rbind(state.fips, c(15, "HI"))
rownames(state.fips) <- state.fips$abb
fips.state <- state.fips
rownames(fips.state) <- fips.state$fips
data(county.fips)

## The following data, which is required to produce the graph, is here:
## http://publications.newberry.org/ahcbp/
histstates <- readOGR("data/US_AtlasHCB_StateTerr_Gen001/US_HistStateTerr_Gen001_Shapefile", layer = "US_HistStateTerr_Gen001")

ss2000 <- which(histstates$START_N <= 20001231 & histstates$END_N >= 20001231)
states2000 <- histstates[ss2000,]
states2000 <- states2000[!(states2000$ABBR_NAME %in% c("AK", "HI")),]

# load("census1860-interp.RData")
southern.states <- c("Alabama", "Arkansas", "Florida", "Georgia", "Kentucky", "Louisiana",
                      "Mississippi", "Missouri", "North Carolina", "South Carolina", "Tennessee", "Texas",
                     "Virginia", "West Virginia")

# counties1860 <- merge(counties1860, census1860, by = "fips")
# counties1850 <- merge(counties1850, census1850, by = "fips")

pslave.bins <- cut(counties2000$pslave1860, breaks = seq(0,1, length = 6))
pslave1850.bins <- cut(counties2000$pslave1850, breaks = seq(0,1, length = 6))
pslave1840.bins <- cut(counties2000$pslave1840, breaks = seq(0,1, length = 6))
mcols <-  c("#F1EEF6", "#D4B9DA", "#C994C7", "#DF65B0", "#DD1C77", "#980043")
leg.text <- c("0-20%", "21-40%", "41-60%", "61-80%", "81-100%")
names(mcols) <- levels(pslave.bins)

#cairo_pdf(file = "figs/pslave2000-map.pdf", width = 7, height = 4, pointsize = 8, family = "Minion Pro")
plot(counties2000[counties2000$STATE_TERR %in% southern.states,], col = mcols[pslave.bins[counties2000$STATE_TERR %in% southern.states]], border = NA)
plot(states2000[states2000$FULL_NAME %in% southern.states,], border = "grey30", add = TRUE, lwd = 0.25)
legend("topleft", horiz = FALSE, col = mcols, legend =  leg.text, bty = "n", fill = mcols, border = "white")
#dev.off()

# countydata <- read.csv("data/abs-jop-countydata.csv", stringsAsFactors = FALSE)

cotton.bins <- cut(countydata$cottonsuit, breaks = quantile(countydata$cottonsuit, c(0, 0.4, 0.5, 0.6, 0.7, 0.8, 1), na.rm=TRUE))
mcols <- brewer.pal(6, "Greens")
#leg.text <- c("0-20%", "21-40%", "41-60%", "61-80%", "81-100%")
names(mcols) <- levels(cotton.bins)

tmp.data <- data.frame(fips = countydata$fips, cotton.cols = as.character(mcols[cotton.bins]))
mp <- map("county", plot=FALSE,namesonly=TRUE)
tmp.data <- merge(county.fips, tmp.data, by = "fips", all.x = TRUE)
rownames(tmp.data) <- tmp.data$polyname

#cairo_pdf(file = "figs/cotton-suit-map.pdf", width = 7, height = 4, pointsize = 8, family = "Minion Pro")
map("county", fill = TRUE, col = as.character(tmp.data[mp, "cotton.cols"]),resolution = 0,lty = 0,projection = "polyconic")
#points(x = -92, y = 34, pch = 19, cex = 2)
map("state",col = "black",fill=FALSE,add=TRUE,lty=1,lwd=1,projection="polyconic")
legend("bottomleft", legend = c("Least Suitable", NA, NA, NA, NA, "Most Suitable"), fill = mcols, bty = "o", border = NA, y.intersp = 0.5, bg = grey(0.8), box.lwd = 0)
#dev.off()

```



### Figure 2. Bivariate relationships between proportion slave in 1860 and the four outcome measures with a linear fit.

```{r figure2, echo = FALSE}
### Make figure 2.

par(mfrow = c(1,4), mar = 0.1 + c(4, 3, 2, 0.5), cex.main = 1)
plot(south.counties$pslave1860, south.counties$dem, pch = 19, col = "#33333333", xlab = "Proportion Slave, 1860", ylab = "", main = "Proportion Democrat", yaxt = "n", cex = south.counties$sample.size/100)
axis(side = 2, las = 2)
abline(lm(dem ~ pslave1860, data = south.counties, weights = sample.size), lwd = 2, col = "#AA0000")
plot(south.counties$pslave1860, south.counties$affirm, pch = 19, col = "#33333333", xlab = "Proportion Slave, 1860", ylab = "", main = "Affirmative Action", yaxt = "n", cex = south.counties$sample.size/100)
axis(side = 2, las = 2)
abline(lm(affirm ~ pslave1860, data = south.counties, weights = sample.size), lwd = 2, col = "#AA0000")
plot(south.counties$pslave1860, south.counties$resent, pch = 19, col = "#33333333", xlab = "Proportion Slave, 1860", ylab="", main = "Racial Resentment", yaxt = "n", cex = south.counties$sample.size.res/75)
axis(side = 2, las = 2)
abline(lm(resent ~ pslave1860, data = south.counties, weights = sample.size.res), lwd = 2, col = "#AA0000")
with(subset(nes.counties, state.abb %in% st.list), plot(pslave1860, wtherm-btherm, cex = sample.size.bt/40, pch = 19, col = "#33333333", xlab = "Proportion Slave, 1860", ylab = "", main = "White - Black Therm. Score", las = 1, xlim = c(0, 0.9)))
abline(lm(I(wtherm-btherm) ~ pslave1860, weights = sample.size.bt, data = subset(nes.counties, state.abb %in% st.list)), lwd = 2, col = "#AA0000")

```


```{r echo = FALSE}
### Models.

# Regress democratic affiliation (self-reported) dummy on slaveholding proportion
# in 1860 (the key variable of interest) with WLS (weighted least squares). This
# is used when the standard deviation of the error term is not constant over all
# values of the predictors (i.e., heteroskedastistic). It effectively reduces the
# predictive power of observations in the regression that are more uncertain.

cnty.res <- lm(dem ~ pslave1860, data = south.counties, weights = sample.size)

# Now with state fixed effects.

cnty.res.fe <- lm(dem ~ pslave1860 + state.abb, data = south.counties, weights = sample.size)

# Regressions on base1860.form include: county area  in 2000, latitude and longitude (and squared), "ruggedness."
# 1860 variables: Gini coefficients on land holdings, small farm proportions, log population, log farm value,
# proportion free blacks, rail access, waterway access, and state fixed effects.

# Regress democratic affiliation on all of these variables (using the "update" function to update the model).

cnty.res.full <- lm(update(base1860.form, dem ~ .), data = south.counties, weights = sample.size)

# Regress affirmative action dummy on the proportion of slaves.

cnty.aff <- lm(affirm ~ pslave1860, data = south.counties, weights = sample.size)

# With state fixed effects.

cnty.aff.fe <- lm(affirm ~ pslave1860 + state.abb, data = south.counties, weights = sample.size)

# Regress affirmative action dummy on the many predictors listed above.

cnty.aff.full <- lm(update(base1860.form, affirm ~ .), data = south.counties, weights = sample.size)

# Regress average of the two CCES racial resentment questions on the proportion of slaves.

cnty.resent <- lm(resent ~ pslave1860, data = south.counties, weights = sample.size.res)

# With state fixed effects.

cnty.resent.fe <- lm(resent ~ pslave1860 +  state.abb, data = south.counties, weights = sample.size.res)

# Regress average resentment questions on the many predictors listed above.

cnty.resent.full <- lm(update(base1860.form, resent ~ .), data = south.counties, weights = sample.size.res)


## National Election Survey Individual Results

# Regress the thermometer difference (white therm - black therm) on the proportion enslaved with WLS.
# Also get robust standard errors, which is a way to obtain unbiased standard errors of 
# coefficients under heteroscedasticity.

therm.mod <- lm(therm.diff ~ pslave1860, data = ns.whites, weights = weight)
therm.mod.rse <- robust.se(therm.mod, clvar = "fips")

# Add state-year fixed effects.

therm.mod.fe <- lm(therm.diff ~ pslave1860 + state.abb*as.factor(year), data = ns.whites, weights = weight)
therm.mod.fe.rse <- robust.se(therm.mod.fe, clvar = "fips")

# Regress thermometer difference on the long list of predictors above with state-year fixed effects.

therm.1860 <- lm(update(base1860.form, therm.diff ~ . + state.abb*as.factor(year)), data = ns.whites, weights = weight)
therm.1860.rse <- robust.se(therm.1860, clvar = "fips")
```

### Table 1. Effects of Slavery on White Political Attitudes

```{r table1-1, echo = FALSE, results = FALSE}
### Table 1.

# Add in some custom LaTeX, like the check marks.

tab1.alt <- stargazer(cnty.res, cnty.res.full, cnty.aff.full, cnty.resent.full, therm.1860,
  se = list(NULL, NULL, NULL, NULL, therm.1860.rse[, 2]),
  keep = "pslave1860", style = "apsr", omit.stat = c("adj.rsq", "ll", "F", "ser"),
  covariate.labels = c("Prop. Slave, 1860"),
  dep.var.labels = c("Prop Democrat", "Affirm. Action", "Racial Resentment"), 
  column.sep.width = "5pt", float = FALSE, header = FALSE,
  add.lines = list(rep("", 4), c("Level", "County", "County", "County", "County", "Individual"), ch.row("1860 Covariates", c(FALSE, rep(TRUE, 3), FALSE)), ch.row("State Fixed Effects", c(FALSE, rep(TRUE, 4))), ch.row("State-Year Fixed Effects", c(rep(FALSE, 4), TRUE)), ch.row("Clustered SEs", c(rep(FALSE, 4), TRUE)), rep("", 4)), multicolumn = TRUE
)

```

\vspace{2em}

```{r table1-2, echo = FALSE, results="asis"}
### Print table 1.

# Add in some custom LaTeX, like the check marks.

tab1.alt[4] <- "\\\\[-1.8ex] & \\multicolumn{2}{c}{Proportion} & Support for & Racial  & White-Black  \\\\ "
tab1.alt <- append(tab1.alt, " & \\multicolumn{2}{c}{Democrat} & Affirm. Action &  Resentment & Therm. Diff  \\\\ ", after = 4)
tab1.alt <- gsub("\\{\\*\\}", "\\{\\\\dagger\\}", tab1.alt)
tab1.alt <- gsub("\\{\\*\\*\\}", "\\{\\*\\}", tab1.alt)
tab1.alt <- gsub("\\{\\*\\*\\*\\}", "\\{\\*\\*\\}", tab1.alt)
tab1.alt <- tab1.alt[-(length(tab1.alt)-1)]
cat(paste(tab1.alt, collapse = "\n"), "\n")
```


```{r echo = FALSE, results = FALSE}
### Instrumental variable estimates.

# In the second stage, regress democratic affiliation (dummy), affirmative action dummy, average resentment, and thermometer difference on:
# proportion slaves; geographic predictors (rugged, lat/long, etc.); waterway access; and state fixed effects.
# The first stage contains: cotton suitability measure; geographic predictors; waterway access; and state fixed effects.

# In the first stage, the endogenous variable (proportion enslaved) is regressed on the instrument or instruments (cotton suitability), along with other controls. The estimated coefficients from the first-stage regression are used to predict the endogenous variable.
# In the second stage, the dependent variable (democratic affiliation) is regressed on the predicted values of the endogenous variable (proportion enslaved), along with the exogenous controls.
# If the instrument is valid, the estimated coefficient on the predicted endogenous variable in the second stage is an unbiased estimate of the desired parameter (in our case, the demand elasticity).
# https://rpubs.com/wsundstrom/t_ivreg

# Weighted IV regressions for the four outcomes of interest.

cnty.iv <- ivreg(update(base.iv.form, dem ~ .), data = south.counties, weights = sample.size)
cnty.aff.iv <- ivreg(update(base.iv.form, affirm  ~ .), data = south.counties, weights = sample.size)
cnty.resent.iv <- ivreg(update(base.iv.form, resent  ~ .), data = south.counties, weights = sample.size.res)
therm.cty.iv <- ivreg(update(base.iv.form, therm.diff ~ .), data = nes.counties, weights = sample.size.td, subset = abs.sample == 1)

# This is the first-stage OLS regression of proportion enslaved on cotton suitability and controls.

cnty.res.first <- lm(base.first.form, data = south.counties)

# Print the table of results.

iv.tab <- stargazer(cnty.res.first, cnty.iv, cnty.aff.iv, cnty.resent.iv,
          keep = c("cotton", "pslave1860"), style = "apsr", omit.stat = c("ll", "rsq", "adj.rsq", "ser"),
                    covariate.labels = c("Cotton Suitability", "Prop. Slave, 1860"), dep.var.labels = c("Prop Slave", "Prop Democrat", "Affirm. Action", "Racial Resentment"), column.sep.width = "0pt", float = FALSE, header = FALSE, add.lines = list(rep("", 5), ch.row("State Fixed Effects", rep(TRUE,4)), ch.row("Geographic Controls", rep(TRUE,4)), c("Model", rep("2SLS", 4)), c("", "First Stage", rep("Second Stage", 3)), rep("", 5)), multicolumn = TRUE, model.names = FALSE)
iv.tab[4] <- "\\\\[-1.8ex] & Prop. Slave & Prop. Democrat & Affirm. Action & Racial Resentment \\\\ "
iv.tab <- gsub("\\{\\*\\}", "\\{\\\\dagger\\}", iv.tab)
iv.tab <- gsub("\\{\\*\\*\\}", "\\{\\*\\}", iv.tab)
iv.tab <- gsub("\\{\\*\\*\\*\\}", "\\{\\*\\*\\}", iv.tab)
iv.tab <- iv.tab[-(length(iv.tab)-1)]
cat(paste(iv.tab, collapse = "\n"), "\n")

iv.tab.alt <- stargazer(cnty.res.first, cnty.iv, cnty.aff.iv, cnty.resent.iv, therm.cty.iv,
          keep = c("cotton", "pslave1860"), style = "apsr", omit.stat = c("ll", "rsq", "adj.rsq", "ser"),
                    covariate.labels = c("Cotton Suitability", "Prop. Slave, 1860"), dep.var.labels = c("Prop Slave", "Prop Democrat", "Affirm. Action", "Racial Resentment", "BW"), column.sep.width = "0pt", float = FALSE, header = FALSE, add.lines = list(rep("", 5), ch.row("State Fixed Effects", rep(TRUE,5)), ch.row("Geographic Controls", rep(TRUE,5)), c("Model", rep("2SLS", 5)), c("", "First Stage", rep("Second Stage", 4)), rep("", 5)), multicolumn = FALSE, model.names = FALSE)
```

### Table 2. Instrumental Variables Estimates of the Effect of Slavery

```{r echo = FALSE, results = "asis"}
iv.tab.alt[4] <- "\\\\[-1.8ex] & Proportion & Proportion & Support for & Racial  & White-Black  \\\\ "
iv.tab.alt <- append(iv.tab.alt, " & Slave, 1860 & Democrat & Affirm. Action &  Resentment & Therm. Diff  \\\\ ", after = 4)
iv.tab.alt <- gsub("\\{\\*\\}", "\\{\\\\dagger\\}", iv.tab.alt)
iv.tab.alt <- gsub("\\{\\*\\*\\}", "\\{\\*\\}", iv.tab.alt)
iv.tab.alt <- gsub("\\{\\*\\*\\*\\}", "\\{\\*\\*\\}", iv.tab.alt)
iv.tab.alt <- iv.tab.alt[-(length(iv.tab.alt)-1)]
cat(paste(iv.tab.alt, collapse = "\n"), "\n")
```


```{r echo = FALSE, results = FALSE, cache = TRUE}
### Effects of Slavery on White Attitudes Net the Effect of the Contemporary Proportions of African Americans

# Below are some unused regressions. Seems like they still had significant results.

# cnty.res.blk70.ptbias <- lm(update(base1860.form, dem ~ . + blkprop70), data =south.counties, weights = sample.size)
# cnty.aff.blk70.ptbias <- lm(update(base1860.form, affirm ~ . + blkprop70), data = south.counties, weights = sample.size)
# cnty.resent.blk70.ptbias <- lm(update(base1860.form, resent ~ . + blkprop70), data = south.counties, weights = sample.size.res)

# Regressions of outcomes of interest on three predictors (no temperature),
# controlling for the proportion of African Americans in 2000.

cnty.res.blk00.ptbias <- lm(update(base1860.form, dem ~ . + blkprop00), data =south.counties, weights = sample.size)
cnty.aff.blk00.ptbias <- lm(update(base1860.form, affirm ~ . + blkprop00), data = south.counties, weights = sample.size)
cnty.resent.blk00.ptbias <- lm(update(base1860.form, resent ~ . + blkprop00), data = south.counties, weights = sample.size.res)

# Regress democratic affiliation on all the variables in the base function NET of the proportion
# of American Americans in 2000.
# Do this by first getting a parameter coefficient for how black population changes democratic affiliation.
# Then multiply that coefficient by the actual proportion to remove the amount of democratic affiliation
# explained by the AfAm population. Then net value should represent only the democratic share among non-blacks.

cnty.dem.blk00.first <- lm(update(base1860.form, dem ~ . + blkprop00 +log(totpop00) +highsch90 + unemp + log(medinc00) + wbincratio00), data =south.counties, weights = sample.size)
cnty.dem.blk00 <- lm(update(base1860.form, I(dem - coef(cnty.dem.blk00.first)["blkprop00"]*(blkprop00)) ~ .), data =south.counties, weights = sample.size)

# Do the same for affirmative action and resentment.

cnty.aff.blk00.first <- lm(update(base1860.form, affirm ~ . + blkprop00 +log(totpop00) +highsch90 + unemp + log(medinc00) + wbincratio00), data =south.counties, weights = sample.size)
cnty.aff.blk00 <- lm(update(base1860.form, I(affirm - coef(cnty.aff.blk00.first)["blkprop00"]*(blkprop00)) ~ .), data =south.counties, weights = sample.size)
cnty.resent.blk00.first <- lm(update(base1860.form, resent ~ . + blkprop00 +log(totpop00) +highsch90 + unemp + log(medinc00) + wbincratio00), data =south.counties, weights = sample.size.res)
cnty.resent.blk00 <- lm(update(base1860.form, I(resent - coef(cnty.resent.blk00.first)["blkprop00"]*(blkprop00)) ~ .), data =south.counties, weights = sample.size.res)


# Bootstrap the standard errors.

set.seed(6251983)
boots <- 1000
cnty.dem.blk00.boots <- rep(NA, times = boots)
cnty.aff.blk00.boots <- rep(NA, times = boots)
cnty.resent.blk00.boots <- rep(NA, times = boots)
for (b in 1:boots) {
  sc.star <- south.counties[sample(1:nrow(south.counties), replace = TRUE),]
  boot.dem.first <- lm(update(base1860.form, dem ~ . + blkprop00 +log(totpop00) +highsch90 + unemp + log(medinc00) + wbincratio00), data =sc.star, weights = sample.size)
  boot.dem  <- lm(update(base1860.form, I(dem - coef(boot.dem.first)["blkprop00"]*(blkprop00)) ~ .), data =sc.star, weights = sample.size)
  cnty.dem.blk00.boots[b] <- coef(boot.dem)["pslave1860"]

  boot.aff.first <- lm(update(base1860.form, affirm ~ . + blkprop00 +log(totpop00) +highsch90 + unemp + log(medinc00) + wbincratio00), data =sc.star, weights = sample.size)
  boot.aff  <- lm(update(base1860.form, I(affirm - coef(boot.aff.first)["blkprop00"]*(blkprop00)) ~ .), data =sc.star, weights = sample.size)
  cnty.aff.blk00.boots[b] <- coef(boot.aff)["pslave1860"]

  boot.resent.first <- lm(update(base1860.form, resent ~ . + blkprop00 +log(totpop00) +highsch90 + unemp + log(medinc00) + wbincratio00), data =sc.star, weights = sample.size.res)
  boot.resent <- lm(update(base1860.form, I(resent - coef(boot.resent.first)["blkprop00"]*(blkprop00)) ~ .), data =sc.star, weights = sample.size.res)
  cnty.resent.blk00.boots[b] <- coef(boot.resent)["pslave1860"]

}

# Put bootstrapped SEs into a holder (we don't calculate the BSE for
# the other coefficients since we don't care about them and don't
# report them in the paper)

dem.bse <- summary(cnty.dem.blk00)$coef[,2]
dem.bse["pslave1860"] <- sd(cnty.dem.blk00.boots)
aff.bse <- summary(cnty.aff.blk00)$coef[,2]
aff.bse["pslave1860"] <- sd(cnty.aff.blk00.boots)
resent.bse <- summary(cnty.resent.blk00)$coef[,2]
resent.bse["pslave1860"] <- sd(cnty.resent.blk00.boots)

# Generate table 3.

blkprop.tab <- stargazer(cnty.res.blk00.ptbias, cnty.dem.blk00, cnty.aff.blk00.ptbias, cnty.aff.blk00, cnty.resent.blk00.ptbias, cnty.resent.blk00,
          keep = c("pslave1860", "blkprop00"), style = "apsr", omit.stat = c("ll", "adj.rsq", "F", "ser"), se = list(NULL, dem.bse, NULL, aff.bse, NULL, resent.bse),
          covariate.labels = c("Prop. Slave, Direct Effect", "Prop. Black, 2000"), dep.var.labels = c("Prop Democrat", "Affirm. Action", "Racial Resentment"), column.sep.width = "5pt", float = FALSE, header = FALSE, add.lines = list(rep("", 7), ch.row("State Fixed Effects", rep(TRUE, 6)), ch.row("1860 Covariates", rep(TRUE, 6)), ch.row("Bootstrapped SEs", rep(c(FALSE,TRUE), 3)), c("Model", rep(c("WLS", "Seq. g-est."), 3)), rep("", 7)), multicolumn = TRUE)
```

### Table 3. Effects of Slavery on White Attitudes Net the Effect of the Contemporary Proportions of African Americans

```{r echo = FALSE,results = "asis"}
blkprop.tab[4] <- "\\\\[-1.8ex] &  \\multicolumn{2}{c}{Prop. Democrat} & \\multicolumn{2}{c}{Affirm. Action} & \\multicolumn{2}{c}{Racial Resentment} \\\\ "
blkprop.tab <- gsub("\\{\\*\\}", "\\{\\\\dagger\\}", blkprop.tab)
blkprop.tab <- gsub("\\{\\*\\*\\}", "\\{\\*\\}", blkprop.tab)
blkprop.tab <- gsub("\\{\\*\\*\\*\\}", "\\{\\*\\*\\}", blkprop.tab)
blkprop.tab <- blkprop.tab[-(length(blkprop.tab)-1)]
cat(paste(blkprop.tab, collapse = "\n"), "\n")
```

### Figure 3. Characteristics of white out-migrants and in-migrants compared to white nonmigrants for high-slave and low-slave counties, where migration took place between 1935 and 1939.

This takes too long to knit.

```{r echo = FALSE, message = FALSE, warning = FALSE, cache = TRUE}
## 1940 PUMS
# pums <- read.csv(gzfile("data/usa_00015_1940_census.csv.gz"), stringsAsFactors = FALSE)
# names(pums) <- tolower(names(pums))
# pums$county <- substr(pums$county, 0, nchar(pums$county)-1)
# pums$county[nchar(pums$county) == 1] <- paste("00", pums$county[nchar(pums$county) == 1], sep = "")
# pums$county[nchar(pums$county) == 2] <- paste("0", pums$county[nchar(pums$county) == 2], sep = "")
# pums$fips <- as.numeric(paste(pums$statefip, pums$county, sep = ""))
# is.na(pums$incwage) <- which(pums$incwage == 999999)
# is.na(pums$fwage1) <- which(pums$fwage1 == 99999)
# is.na(pums$valueh) <- which(pums$valueh == 999999)
# pums.blkmen <- pums[which(pums$race == 2 & pums$sex == 1 & pums$age >18 & pums$incwage > 0),]
# pums.whtmen <- pums[which(pums$race == 1 & pums$sex == 1 & pums$age >18 & pums$incwage > 0),]
# pums.blkmen$logwage <- log(pums.blkmen$incwage)
# pums.whtmen$logwage <- log(pums.whtmen$incwage)
# pums.blkmen <- cast(melt(pums.blkmen[c("fips", "logwage")], id = c("fips")), fips ~ variable, mean, na.rm = TRUE)
# pums.whtmen <- cast(melt(pums.whtmen[c("fips", "logwage")], id = c("fips")), fips ~ variable, mean, na.rm = TRUE)
# pums.raceineq <- merge(x=pums.blkmen, y = pums.whtmen, by = "fips", all = TRUE)
# names(pums.raceineq) <- c("fips", "blklwage1940", "whtlwage1940")
# 
# data(state.fips)
# state.fips <- unique(state.fips[,c("fips","abb")])
# state.fips$abb <- as.character(state.fips$abb)
# state.fips <- rbind(state.fips, c(2, "AK"))
# state.fips <- rbind(state.fips, c(15, "HI"))
# rownames(state.fips) <- state.fips$abb
# fips.state <- state.fips
# rownames(fips.state) <- fips.state$fips
# data(county.fips)
# st.abbs <- read.csv("data/state-abbreviations.csv", stringsAsFactors = FALSE)
# st.abbs$State <- tolower(st.abbs$State)
# rownames(st.abbs) <- st.abbs$State
# county.fips$polyname <- gsub(":.*$", "", county.fips$polyname)
# county.fips$county.name <- unlist(lapply(strsplit(as.character(county.fips$polyname), split = ","), function (x) x[2]))
# county.fips$state.name <- unlist(lapply(strsplit(as.character(county.fips$polyname), split = ","), function (x) x[1]))
# county.fips$state.abb <- st.abbs[county.fips$state.name, "Abbreviation"]
# county.fips$sfips <- state.fips[county.fips$state.abb, "fips"]
# county.fips.u <- unique(county.fips)
# 
# ## this code finds the fips code for the 1935 county based on string
# ## matching
# pums$mcny5str <- tolower(pums$mcny5str)
# pums$mcny5str[which(pums$mcny5str == "-")] <- NA
# pums$mcny5str[which(pums$mcny5str == "\\")] <- NA
# pums$mcny5str[which(pums$mcny5str == "")] <- NA
# pums$mcny5str[which(pums$migrate5 %in% c(0,1))] <- NA
# cnames <- unique(pums$mcny5str)
# 
# move.rows <- which(!is.na(pums$mcny5str))
# pums$cname.match <- NA
# pums$fips1935 <- NA
# 
# library(stringdist)
# for (i in move.rows) {
#   cat("this row: ", i, "\n")
#   this.state <- county.fips.u[which(county.fips.u$sfips == pums$migplac5[i]),]
#   match.rows <- amatch(pums$mcny5str[i], this.state$county.name, method = "jw", p = 0.1,
#                        maxDist = 0.2)
# 
#   if (!is.na(match.rows)) {
#     if (length(match.rows) == 1) {
#       pums$fips1935[i] <- this.state$fips[match.rows]
#       pums$cname.match[i] <- 0
#     } else if (length(match.rows) > 1) {
#       cat("multiple fuzzy matches: ", i, "\n")
#     }
#   }
# }
# 
# pums$fips1935[is.na(pums$fips1935)] <- pums$fips[is.na(pums$fips1935)]
# pums$statefip1935 <- as.numeric(substr(as.character(pums$fips1935), start = 1, stop = ifelse(nchar(as.character(pums$fips1935)) == 4, 1, 2)))
# pums18w <- pums[which(pums$age >= 18 & pums$race == 1),]
# pums18b <- pums[which(pums$age >= 18 & pums$race == 2),]
# 
# 
# st.list <- c(1, 5, 12, 13, 21, 22, 28, 37, 45, 47, 48, 51, 54)
# pums18w.south <- pums18w[which(pums18w$statefip %in% st.list | pums18w$statefip1935 %in% st.list),]
# pums18b.south <- pums18b[which(pums18b$statefip %in% st.list | pums18b$statefip1935 %in% st.list),]
# 
# save(pums18w.south, file = "pums40-migration-white.RData")
# save(pums18b.south, file = "pums40-migration-black.RData")
# 
# 
# countydata <- read.csv("data/abs-jop-countydata.csv", stringsAsFactors = FALSE)
# load("pums40-migration-white.RData")
# load("pums40-migration-black.RData")
# 
# pums18w.south <- merge(pums18w.south, countydata, by = "fips")
# pums18w.south <- merge(pums18w.south, countydata, by.x = "fips1935", by.y = "fips", suffixes = c("","1935"))
# 
# pums18b.south <- merge(pums18b.south, countydata, by = "fips")
# pums18b.south <- merge(pums18b.south, countydata, by.x = "fips1935", by.y = "fips", suffixes = c("","1935"))
# 
# st.abb.list <- c("AL", "AR", "GA", "FL", "KY", "LA","MS", "MO", "NC", "SC", "TN", "TX", "VA", "WV")
# ## http://people.su.se/~ma/clustering.pdf
# robust.se <- function(fm, clvar){
#     # R-codes (www.r-project.org) for computing
#     # clustered-standard errors. Mahmood Arai, Jan 26, 2008.
#     # The arguments of the function are:
#     # fitted model, cluster1 and cluster2
#     # You need to install libraries `sandwich' and `lmtest'
#   library(sandwich);library(lmtest);
#   x <- eval(fm$call$data, envir = parent.frame())
#   if ("polr" %in% class(fm)) {
#     require(MASS)
#     cluster <- x[rownames(predict(fm, type = "probs")), clvar]
#   } else {
#     cluster <- x[names(predict(fm)), clvar]
#   }
#   M <- length(unique(cluster))
#   N <- length(cluster)
#   K <- dim(vcov(fm))[1]
#   dfc <- (M/(M-1))*((N-1)/(N-K))
#   uj  <- apply(estfun(fm),2, function(x) tapply(x, cluster, sum));
#   vcovCL <- dfc*sandwich(fm, meat=crossprod(uj)/N)
#   return(vcovCL)
# }
# 
# marginal.se <- function(fm, xz, z0, vcv) {
#   x <- strsplit(xz, ":")[[1]][1]
#   z <- strsplit(xz, ":")[[1]][2]
#   coef1 <- coef(fm)[x]
#   coef2 <- coef(fm)[z]
#   coef3 <- coef(fm)[xz]
#   if (missing(vcv)) {
#     vcv <- vcov(fm)
#   }
#   marg.eff <- coef1 + z0*coef3
#   marg.se <- sqrt(vcv[x,x] + z0^2 * vcv[xz,xz] + 2 * z0 * vcv[xz,x])
#   return(list(marg.eff = marg.eff, marg.se = marg.se))
# }
# 
# pums18w.south$migrant <- 1 * (pums18w.south$fips != pums18w.south$fips1935)
# pums18b.south$migrant <- 1 * (pums18b.south$fips != pums18b.south$fips1935)
# 
# out.base.covs <- formula( ~ migrant*pslave18601935 + log(coarea001935) + rugged1935 + latitude1935 + I(latitude1935^2)  + longitude1935 + I(longitude1935^2) + land.ineq18601935 + sfarmprop18601935 + log(totpop18601935)+ log(fvalpac18601935) + log(acimp18601935) + fbprop18601935 + rail18601935 + water18601935 + state.abb1935)
# 
# out.educ <- lm(update(out.base.covs, I(educ/sd(educ)) ~ .), data = pums18w.south, subset = state.abb1935 %in% st.abb.list)
# out.educ.cse <- robust.se(out.educ, "fips1935")
# out.educ.hi <- marginal.se(out.educ, "migrant:pslave18601935", 0.4, out.educ.cse)
# out.educ.lo <- marginal.se(out.educ, "migrant:pslave18601935", 0.1, out.educ.cse)
# coeftest(out.educ, out.educ.cse)
# 
# out.higrade <- lm(update(out.base.covs, higrade ~ .), data = pums18w.south, subset = state.abb1935 %in% st.abb.list)
# out.higrade.cse <- robust.se(out.higrade, "fips1935")
# out.higrade.hi <- marginal.se(out.higrade, "migrant:pslave18601935", 0.4, out.higrade.cse)
# out.higrade.lo <- marginal.se(out.higrade, "migrant:pslave18601935", 0.1, out.higrade.cse)
# coeftest(out.higrade, out.higrade.cse)
# 
# out.age <- lm(update(out.base.covs, I(age/sd(age)) ~ .), data = pums18w.south, subset = state.abb1935 %in% st.abb.list)
# out.age.cse <- robust.se(out.age, "fips1935")
# out.age.hi <- marginal.se(out.age, "migrant:pslave18601935", 0.4, out.age.cse)
# out.age.lo <- marginal.se(out.age, "migrant:pslave18601935", 0.1, out.age.cse)
# coeftest(out.age, out.age.cse)
# 
# 
# out.sex <- lm(update(out.base.covs, I(sex==2) ~ .), data = pums18w.south, subset = state.abb1935 %in% st.abb.list)
# out.sex.cse <- robust.se(out.sex, "fips1935")
# out.sex.hi <- marginal.se(out.sex, "migrant:pslave18601935", 0.4, out.sex.cse)
# out.sex.lo <- marginal.se(out.sex, "migrant:pslave18601935", 0.1, out.sex.cse)
# coeftest(out.sex, out.sex.cse)
# 
# out.nativity <- lm(update(out.base.covs, I(nativity==1) ~ .), data = pums18w.south, subset = state.abb1935 %in% st.abb.list)
# out.nativity.cse <- robust.se(out.nativity, "fips1935")
# out.nativity.hi <- marginal.se(out.nativity, "migrant:pslave18601935", 0.4, out.nativity.cse)
# out.nativity.lo <- marginal.se(out.nativity, "migrant:pslave18601935", 0.1, out.nativity.cse)
# coeftest(out.nativity, out.nativity.cse)
# 
# out.bpl <- lm(update(out.base.covs, I(statefip1935 == bpl) ~ .), data = pums18w.south, subset = state.abb1935 %in% st.abb.list)
# out.bpl.cse <- robust.se(out.bpl, "fips1935")
# out.bpl.hi <- marginal.se(out.bpl, "migrant:pslave18601935", 0.4, out.bpl.cse)
# out.bpl.lo <- marginal.se(out.bpl, "migrant:pslave18601935", 0.1, out.bpl.cse)
# coeftest(out.bpl, out.bpl.cse)
# 
# out.fbpl <- lm(update(out.base.covs, I(statefip1935 == fbpl) ~ .), data = pums18w.south, subset = state.abb1935 %in% st.abb.list)
# out.fbpl.cse <- robust.se(out.fbpl, "fips1935")
# out.fbpl.hi <- marginal.se(out.fbpl, "migrant:pslave18601935", 0.4, out.fbpl.cse)
# out.fbpl.lo <- marginal.se(out.fbpl, "migrant:pslave18601935", 0.1, out.fbpl.cse)
# coeftest(out.fbpl, out.fbpl.cse)
# 
# out.mbpl <- lm(update(out.base.covs, I(statefip1935 == mbpl) ~ .), data = pums18w.south, subset = state.abb1935 %in% st.abb.list)
# out.mbpl.cse <- robust.se(out.mbpl, "fips1935")
# out.mbpl.hi <- marginal.se(out.mbpl, "migrant:pslave18601935", 0.4, out.mbpl.cse)
# out.mbpl.lo <- marginal.se(out.mbpl, "migrant:pslave18601935", 0.1, out.mbpl.cse)
# coeftest(out.mbpl, out.mbpl.cse)
# 
# out.wkswork <- lm(update(out.base.covs, I(wkswork1/sd(wkswork1)) ~ .), data = pums18w.south, subset = state.abb1935 %in% st.abb.list)
# out.wkswork.cse <- robust.se(out.wkswork, "fips1935")
# out.wkswork.hi <- marginal.se(out.wkswork, "migrant:pslave18601935", 0.4, out.wkswork.cse)
# out.wkswork.lo <- marginal.se(out.wkswork, "migrant:pslave18601935", 0.1, out.wkswork.cse)
# coeftest(out.wkswork, out.wkswork.cse)
# 
# out.incwage <- lm(update(out.base.covs, I(fwage1/sd(fwage1, na.rm = TRUE)) ~ .), data = pums18w.south, subset = state.abb1935 %in% st.abb.list)
# out.incwage.cse <- robust.se(out.incwage, "fips1935")
# out.incwage.hi <- marginal.se(out.incwage, "migrant:pslave18601935", 0.4, out.incwage.cse)
# out.incwage.lo <- marginal.se(out.incwage, "migrant:pslave18601935", 0.1, out.incwage.cse)
# coeftest(out.incwage, out.incwage.cse)
# 
# out.rent <- lm(update(out.base.covs, I(rent/sd(rent, na.rm = TRUE)) ~ .), data = pums18w.south, subset = state.abb1935 %in% st.abb.list & rent < 9999)
# out.rent.cse <- robust.se(out.rent, "fips")
# out.rent.hi <- marginal.se(out.rent, "migrant:pslave18601935", 0.4, out.rent.cse)
# out.rent.lo <- marginal.se(out.rent, "migrant:pslave18601935", 0.1, out.rent.cse)
# coeftest(out.rent, out.rent.cse)
# 
# hi.eff <- c(out.educ.hi$marg.eff, out.age.hi$marg.eff, out.sex.hi$marg.eff,
#             out.nativity.hi$marg.eff, out.bpl.hi$marg.eff, out.wkswork.hi$marg.eff, out.incwage.hi$marg.eff, out.rent.hi$marg.eff)
# 
# hi.ses <- c(out.educ.hi$marg.se, out.age.hi$marg.se, out.sex.hi$marg.se,
#             out.nativity.hi$marg.se, out.bpl.hi$marg.se, out.wkswork.hi$marg.se, out.incwage.hi$marg.se, out.rent.hi$marg.se)
# 
# lo.eff <- c(out.educ.lo$marg.eff, out.age.lo$marg.eff, out.sex.lo$marg.eff,
#             out.nativity.lo$marg.eff, out.bpl.lo$marg.eff, out.wkswork.lo$marg.eff, out.incwage.lo$marg.eff, out.rent.lo$marg.eff)
# 
# lo.ses <- c(out.educ.lo$marg.se, out.age.lo$marg.se, out.sex.lo$marg.se,
#             out.nativity.lo$marg.se, out.bpl.lo$marg.se, out.wkswork.lo$marg.se, out.incwage.lo$marg.se, out.rent.lo$marg.se)
# 
# 
# in.base.covs <- formula( ~ migrant*pslave1860 + log(coarea00) + latitude + I(latitude^2) + longitude + I(longitude^2)+ rugged  + land.ineq1860 + sfarmprop1860 + log(totpop1860) + log(fvalpac1860) + log(acimp1860) + fbprop1860  + rail1860 + water1860 + state.abb)
# 
# in.educ <- lm(update(in.base.covs, I(educ/sd(educ)) ~ .), data = pums18w.south, subset = state.abb %in% st.abb.list)
# in.educ.cse <- robust.se(in.educ, "fips")
# in.educ.hi <- marginal.se(in.educ, "migrant:pslave1860", 0.4, in.educ.cse)
# in.educ.lo <- marginal.se(in.educ, "migrant:pslave1860", 0.1, in.educ.cse)
# coeftest(in.educ, in.educ.cse)
# 
# in.higrade <- lm(update(in.base.covs, higrade ~ .), data = pums18w.south, subset = state.abb %in% st.abb.list)
# in.higrade.cse <- robust.se(in.higrade, "fips")
# in.higrade.hi <- marginal.se(in.higrade, "migrant:pslave1860", 0.4, in.higrade.cse)
# in.higrade.lo <- marginal.se(in.higrade, "migrant:pslave1860", 0.1, in.higrade.cse)
# coeftest(in.higrade, in.higrade.cse)
# 
# in.age <- lm(update(in.base.covs, I(age/sd(age)) ~ .), data = pums18w.south, subset = state.abb %in% st.abb.list)
# in.age.cse <- robust.se(in.age, "fips")
# in.age.hi <- marginal.se(in.age, "migrant:pslave1860", 0.4, in.age.cse)
# in.age.lo <- marginal.se(in.age, "migrant:pslave1860", 0.1, in.age.cse)
# coeftest(in.age, in.age.cse)
# 
# 
# in.sex <- lm(update(in.base.covs, I(sex==2) ~ .), data = pums18w.south, subset = state.abb %in% st.abb.list)
# in.sex.cse <- robust.se(in.sex, "fips")
# in.sex.hi <- marginal.se(in.sex, "migrant:pslave1860", 0.4, in.sex.cse)
# in.sex.lo <- marginal.se(in.sex, "migrant:pslave1860", 0.1, in.sex.cse)
# coeftest(in.sex, in.sex.cse)
# 
# in.nativity <- lm(update(in.base.covs, I(nativity==1) ~ .), data = pums18w.south, subset = state.abb %in% st.abb.list)
# in.nativity.cse <- robust.se(in.nativity, "fips")
# in.nativity.hi <- marginal.se(in.nativity, "migrant:pslave1860", 0.4, in.nativity.cse)
# in.nativity.lo <- marginal.se(in.nativity, "migrant:pslave1860", 0.1, in.nativity.cse)
# coeftest(in.nativity, in.nativity.cse)
# 
# in.bpl <- lm(update(in.base.covs, I(statefip == bpl) ~ .), data = pums18w.south, subset = state.abb %in% st.abb.list)
# in.bpl.cse <- robust.se(in.bpl, "fips")
# in.bpl.hi <- marginal.se(in.bpl, "migrant:pslave1860", 0.4, in.bpl.cse)
# in.bpl.lo <- marginal.se(in.bpl, "migrant:pslave1860", 0.1, in.bpl.cse)
# coeftest(in.bpl, in.bpl.cse)
# 
# in.fbpl <- lm(update(in.base.covs, I(statefip == fbpl) ~ .), data = pums18w.south, subset = state.abb %in% st.abb.list)
# in.fbpl.cse <- robust.se(in.fbpl, "fips")
# in.fbpl.hi <- marginal.se(in.fbpl, "migrant:pslave1860", 0.4, in.fbpl.cse)
# in.fbpl.lo <- marginal.se(in.fbpl, "migrant:pslave1860", 0.1, in.fbpl.cse)
# coeftest(in.fbpl, in.fbpl.cse)
# 
# in.mbpl <- lm(update(in.base.covs, I(statefip == mbpl) ~ .), data = pums18w.south, subset = state.abb %in% st.abb.list)
# in.mbpl.cse <- robust.se(in.mbpl, "fips")
# in.mbpl.hi <- marginal.se(in.mbpl, "migrant:pslave1860", 0.4, in.mbpl.cse)
# in.mbpl.lo <- marginal.se(in.mbpl, "migrant:pslave1860", 0.1, in.mbpl.cse)
# coeftest(in.mbpl, in.mbpl.cse)
# 
# in.wkswork <- lm(update(in.base.covs, I(wkswork1/sd(wkswork1)) ~ .), data = pums18w.south, subset = state.abb %in% st.abb.list)
# in.wkswork.cse <- robust.se(in.wkswork, "fips")
# in.wkswork.hi <- marginal.se(in.wkswork, "migrant:pslave1860", 0.4, in.wkswork.cse)
# in.wkswork.lo <- marginal.se(in.wkswork, "migrant:pslave1860", 0.1, in.wkswork.cse)
# coeftest(in.wkswork, in.wkswork.cse)
# 
# in.incwage <- lm(update(in.base.covs, I(fwage1/sd(fwage1, na.rm = TRUE)) ~ .), data = pums18w.south, subset = state.abb %in% st.abb.list)
# in.incwage.cse <- robust.se(in.incwage, "fips")
# in.incwage.hi <- marginal.se(in.incwage, "migrant:pslave1860", 0.4, in.incwage.cse)
# in.incwage.lo <- marginal.se(in.incwage, "migrant:pslave1860", 0.1, in.incwage.cse)
# coeftest(in.incwage, in.incwage.cse)
# 
# in.rent <- lm(update(in.base.covs, I(rent/sd(rent, na.rm = TRUE)) ~ .), data = pums18w.south, subset = state.abb %in% st.abb.list & rent < 9999)
# in.rent.cse <- robust.se(in.rent, "fips")
# in.rent.hi <- marginal.se(in.rent, "migrant:pslave1860", 0.4, in.rent.cse)
# in.rent.lo <- marginal.se(in.rent, "migrant:pslave1860", 0.1, in.rent.cse)
# coeftest(in.rent, in.rent.cse)
# 
# in.hi.eff <- c(in.educ.hi$marg.eff, in.age.hi$marg.eff, in.sex.hi$marg.eff,
#                in.nativity.hi$marg.eff, in.bpl.hi$marg.eff, in.wkswork.hi$marg.eff,
#                in.incwage.hi$marg.eff, in.rent.hi$marg.eff)
# 
# in.hi.ses <- c(in.educ.hi$marg.se, in.age.hi$marg.se, in.sex.hi$marg.se,
#                in.nativity.hi$marg.se, in.bpl.hi$marg.se, in.wkswork.hi$marg.se,
#                in.incwage.hi$marg.se, in.rent.hi$marg.se)
# 
# in.lo.eff <- c(in.educ.lo$marg.eff, in.age.lo$marg.eff, in.sex.lo$marg.eff,
#                in.nativity.lo$marg.eff, in.bpl.lo$marg.eff, in.wkswork.lo$marg.eff,
#                in.incwage.lo$marg.eff, in.rent.lo$marg.eff)
# 
# in.lo.ses <- c(in.educ.lo$marg.se, in.age.lo$marg.se, in.sex.lo$marg.se,
#                in.nativity.lo$marg.se, in.bpl.lo$marg.se, in.wkswork.lo$marg.se,
#                in.incwage.lo$marg.se, in.rent.lo$marg.se)
# 
# ##cairo_pdf("figs/migration1940.pdf", family = "Minion Pro", height = 4, width = 7, pointsize = 9)
# cov.labs <- c("Education", "Age", "Female", "Nativity", "Living in birthstate", "Weeks Worked", "Wages", "Monthly Rent")
# layout(mat = matrix(c(1,1,2,3), nrow = 2, byrow=TRUE), heights = c(0.1,0.9))
# par(mar = c(0,0,0,0))
# plot(1, type = "n", axes=FALSE, xlab="", ylab="")
# legend(x="top", bty = "n", col = c("black", "red"), pch = c(19,17), legend = c("High Prop Slave", "Low Prop Slave"), lty = 1, horiz = TRUE)
# xwindow <- range(c(in.hi.eff + 2*in.hi.ses, in.hi.eff - 2*in.hi.ses, in.lo.eff + 2*in.lo.ses, in.lo.eff - 2*in.lo.ses))
# par(mar = c(4.5,8.5,1,1))
# plot(x = hi.eff, y = 1:length(hi.eff), xlim = xwindow, ylim = c(0,length(hi.eff) + 1), pch = 19, yaxt = "n", bty = "n", ylab = "", main = "Out-migration", xlab = "Migrants vs. Non-migrants")
# axis(side = 2, at = 1:length(hi.eff) - .125, labels = cov.labs, las = 1)
# points(x = lo.eff, y = (1:length(lo.eff)) - 0.25, pch = 17, col = "red")
# segments(x0 = hi.eff - 1.96 * hi.ses, x1 = hi.eff + 1.96 * hi.ses, y0 = 1:length(hi.eff))
# segments(x0 = lo.eff - 1.96 * lo.ses, x1 = lo.eff + 1.96 * lo.ses, y0 = 1:length(lo.eff) - 0.25, col = "red")
# abline(v=0, col = "grey70", lty = 2)
# plot(x = in.hi.eff, y = 1:length(in.hi.eff), xlim = xwindow, ylim = c(0,length(in.hi.eff)+1), pch = 19, yaxt = "n", bty = "n", ylab = "", main = "In-migration", xlab = "Migrants vs. Non-migrants")
# axis(side = 2, at = 1:length(in.hi.eff) - .125, labels = cov.labs, las = 1)
# points(x = in.lo.eff, y = (1:length(in.lo.eff)) - 0.25, pch = 17, col = "red")
# segments(x0 = in.hi.eff - 1.96 * in.hi.ses, x1 = in.hi.eff + 1.96 * in.hi.ses, y0 = 1:length(in.hi.eff))
# segments(x0 = in.lo.eff - 1.96 * in.lo.ses, x1 = in.lo.eff + 1.96 * in.lo.ses, y0 = 1:length(in.lo.eff) - 0.25, col = "red")
# abline(v=0, col = "grey70", lty = 2)
# ##dev.off()

```

### Figure 4. Effect of proportion slave on vote for Democratic presidential candidate in the South over time.

```{r echo = FALSE, warning = FALSE, error = FALSE}
pres.form <- formula(. ~ sprop + log(coarea00) + latitude + I(latitude^2) + longitude + I(longitude^2)+ rugged  + land.ineq + sfarmprop + log(totpop) + log(fvalpc) + log(acimp) + fbprop  + rail + water + state.abb)
pres.iv.form <- Formula(. ~ sprop + log(coarea00) + rugged + latitude + I(latitude^2) + longitude + I(longitude^2)  + water  + state.abb | cottonsuit + log(coarea00) + rugged  + latitude + I(latitude^2) + longitude + I(longitude^2) + water  + state.abb)
year.list <- seq(1840, 1964, by = 4)
outvars <- paste("pdem", year.list, sep = "")
pdemcoefs <- matrix(NA, nrow = length(outvars), ncol = 3)
pdemcoefs.nox <- matrix(NA, nrow = length(outvars), ncol = 3)
pdemcoefs.iv <- matrix(NA, nrow = length(outvars), ncol = 3)
pdemcoefs.rfns <- matrix(NA, nrow = length(outvars), ncol = 3)
pdemcoefs.rf <- matrix(NA, nrow = length(outvars), ncol = 3)
for (y in 1:length(outvars)) {
  if (!(outvars[y] %in% c("pdem1864", "pdem1868"))) {
    ## OLS
    ff <- as.formula(paste(outvars[y], " ~ ."))
    if (year.list[y] < 1924) {
      thismod <- lm(update(pres.form, ff), data = countydata, subset = state.abb %in% st.list)
    } else {
      thismod <- lm(update(base1860.form, ff), data = countydata, subset = state.abb %in% st.list)
    }
    pdemcoefs[y,1] <- 0.25*coef(thismod)[2]
    pdemcoefs[y,2:3] <- 0.25*confint(thismod)[2,]
    ## Only state FEs
    if (year.list[y] < 1924) {
      ff <- as.formula(paste(outvars[y], " ~ sprop + state.abb"))
    } else {
      ff <- as.formula(paste(outvars[y], " ~ pslave1860 + state.abb"))
    }
    thismod <- lm(ff, data = countydata, subset = state.abb %in% st.list)
    pdemcoefs.nox[y,1] <- 0.25*coef(thismod)[2]
    pdemcoefs.nox[y,2:3] <- 0.25*confint(thismod)[2,]
    ## IV
    if (year.list[y] < 1924) {
      ff <- update(pres.iv.form, as.formula(paste(outvars[y], "~ . | .")))
    } else {
      ff <- update(base.iv.form, as.formula(paste(outvars[y], "~ . | .")))
    }
    thismod <- ivreg(ff, data = countydata, subset = state.abb %in% st.list)
    pdemcoefs.iv[y,1] <- coef(thismod)[2]
    pdemcoefs.iv[y,2:3] <- confint(thismod)[2,]
    ## Reduced form in the non-south
    ff <- as.formula(paste(outvars[y], "~ cottonsuit + log(coarea00) + rugged+ latitude + I(latitude^2) + longitude + I(longitude^2)   + state.abb"))
    thismod <- lm(ff, data = countydata, subset = !(state.abb %in% st.list) & !(state.abb %in% c("MD", "DE", "MO")))
    pdemcoefs.rfns[y,1] <- coef(thismod)[2]
    pdemcoefs.rfns[y,2:3] <- confint(thismod)[2,]
    ## Reduced form in the south
    thismod <- lm(ff, data = countydata, subset = state.abb %in% st.list)
    pdemcoefs.rf[y,1] <- coef(thismod)[2]
    pdemcoefs.rf[y,2:3] <- confint(thismod)[2,]
  }
  ## if (outvars[y] %in% c("pdem1860","pdem1864")) {
  ##   pdemcoefs[y,1] <- NA
  ##   pdemcoefs[y,2:3] <- NA
  ##   pdemcoefs.iv[y,1] <- NA
  ##   pdemcoefs.iv[y,2:3] <- NA
  ## }
  ## if (outvars[y] == "pdem1856") {
  ##   pdemcoefs[y,1] <- NA
  ##   pdemcoefs[y,2:3] <- NA
  ## }
}

douglas.ols <- lm(update(pres.form, pdem1860 ~ .), data = countydata, subset = state.abb %in% st.list)
douglas.iv <- ivreg(update(pres.iv.form, pdem1860 ~ .), data = countydata, subset = state.abb %in% st.list)

wallace.ols <- lm(update(base1860.form, wallace68.alt ~ .), data = countydata, subset = state.abb %in% st.list)
wallace.iv <- ivreg(update(base.iv.form, wallace68.alt ~ .), data = countydata, subset = state.abb %in% st.list)
thurmond.ols <- lm(update(base1860.form, thurmond48 ~ .), data = countydata, subset = state.abb %in% st.list)
thurmond.iv <- ivreg(update(base.iv.form, thurmond48 ~ .), data = countydata, subset = state.abb %in% st.list)
obama.ols <- lm(update(base1860.form,  wht.obama.vote ~ .), data = countydata, subset = abs.sample == 1)
obama.iv <- ivreg(update(base.iv.form, wht.obama.vote  ~ .), data = countydata, subset = abs.sample == 1)

##cairo_pdf(file= "../figs/prescountyvote-iv.pdf", family = "Minion Pro", height = 4.5, width = 6.5, pointsize = 9)
plot(x = year.list, y = 0.25*pdemcoefs.iv[,1], ylim = range(c(.25*pdemcoefs.iv,25*confint(obama.iv)["pslave1860",]), na.rm = TRUE), xlim=c(min(year.list),2016), xlab = "Year",
     ylab = "Effect of Slavery on % Democrat", pch = 19, main = "Presidential Elections", bty = "n", yaxt = "n")
abline(v = 1904, lty = 2, col = "grey70")
text(x = 1904, y = 25*confint(obama.iv)["pslave1860",1]+0.5, "All states but KY have\nenacted poll taxes", pos = 4)
abline(v = 1965, lty = 2, col = "grey70")
text(x = 1965, y =  25*confint(obama.iv)["pslave1860",1]+0.5, "Voting Rights Act", pos = 4)
axis(side = 2, las = 2, cex = 0.8)
abline(h=0, col = "grey")
segments(x0 = year.list, y0 = .25*pdemcoefs.iv[,2], y1 = .25*pdemcoefs.iv[,3])
rect(xleft = 1860, xright = 1877, ybottom = -100, ytop=100, col = rgb(.5,.5,.5, alpha = 0.5), border = NA)
text(x = 1860, y = max(.25*pdemcoefs.iv, na.rm=TRUE)-1, "Civil War\nBegins", pos = 2)
text(x = 1877, y = max(.25*pdemcoefs.iv, na.rm=TRUE)-1, "Reconstruction\nEnds", pos = 4)
points(x = 1968, y = .25*coef(wallace.iv)["pslave1860"], pch = 17, col = "indianred")
segments(x0 = 1968, y0 = 0.25*confint(wallace.iv)["pslave1860",1], y1 = 0.25*confint(wallace.iv)["pslave1860",2], col = "indianred")
text(x = 1968, y = 0.25*coef(wallace.iv)["pslave1860"], "Wallace\n1968", pos = 4, col = "indianred")
points(x = 1949, y = .25*coef(thurmond.iv)["pslave1860"], pch = 17, col = "indianred")
segments(x0 = 1949, y0 = 0.25*confint(thurmond.iv)["pslave1860",1], y1 = 0.25*confint(thurmond.iv)["pslave1860",2], col = "indianred")
text(x = 1949, y = 0.35*confint(thurmond.iv)["pslave1860",2], "Thurmond\n1948", pos = 3, col = "indianred")
segments(x0=1949, y0=0.35*confint(thurmond.iv)["pslave1860",2],y1=0.26*confint(thurmond.iv)["pslave1860",2], lty = 3, col = "grey70")
points(x = 2008, y = 25*coef(obama.iv)["pslave1860"], pch = 19)
segments(x0 = 2008, y0 = 25*confint(obama.iv)["pslave1860",1], y1 = 25*confint(obama.iv)["pslave1860",2])
text(x = 2008, y = 25*coef(obama.iv)["pslave1860"], "Obama\n2008", pos = 4)
##dev.off()

##cairo_pdf(file= "../figs/prescountyvote-rform.pdf", family = "Minion Pro", height = 4, width = 6, pointsize = 9)
# plot(x = year.list[year.list > 1868], y = pdemcoefs.rfns[year.list > 1868,1], ylim = range(c(pdemcoefs.rfns[year.list > 1868,], pdemcoefs.rf[year.list > 1868,]), na.rm = TRUE), xlab = "Year",
#      ylab = "Effect of Cotton Suitability on % Democrat", pch = 19, main = "Presidential Elections", bty = "n", yaxt = "n")
# points(x = year.list[year.list > 1868] + 1, y = pdemcoefs.rf[year.list > 1868,1], pch = 19, col = "indianred")
# axis(side = 2, las = 2, cex = 0.8)
# abline(h=0, col = "grey")
# segments(x0 = year.list[year.list > 1868], y0 = pdemcoefs.rfns[year.list > 1868,2], y1 = pdemcoefs.rfns[year.list > 1868,3])
# segments(x0 = year.list[year.list > 1868] + 1, y0 = pdemcoefs.rf[year.list > 1868,2], y1 = pdemcoefs.rf[year.list > 1868,3], col = "indianred")
##dev.off()
```

### Figure 5. Within-state relationship between proportion slave in 1850 in a county and percentage voting for Unionist candidates in 1851 in that county.

```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}
### Figure 5.

ga.votes <- read.csv("data/ga-votes-1824-1860.csv", stringsAsFactors = FALSE)
ga.votes$cfips <- strtrim(ga.votes$V3, nchar(ga.votes$V3)-1)
ga.votes$fips <- as.numeric(paste(13, str_pad(ga.votes$cfips, 3, side = "left", pad = "0"), sep = ""))
is.na(ga.votes) <- ga.votes == 9999999
ga.votes$howell1851 <- ga.votes$V345/ga.votes$V348

ga.votes <- merge(ga.votes, countydata, by = "fips", all.x = TRUE, all.y = FALSE)

# lattice::xyplot(howell1851 ~ sprop1850, data = ga.votes, subset = state.abb %in% st.list , pch = 16, lwd = 4, col.line = "indianred", col = dodgerblue.30, xlab = "Proportion Slave, 1850", ylab = "Howell Cobb Vote-share, 1851", panel =
#                     function(x,y,...) {  panel.xyplot(x, y, ...)
#                                          panel.smoother(x,y,method = "loess", col = "indianred", lwd = 4)})

ms.votes <- read.csv("data/ms-votes-1824-1860.csv", stringsAsFactors = FALSE)
ms.votes$cfips <- strtrim(ms.votes$V3, nchar(ms.votes$V3)-1)
ms.votes$fips <- as.numeric(paste(28, str_pad(ms.votes$cfips, 3, side = "left", pad = "0"), sep = ""))
is.na(ms.votes) <- ms.votes == 9999999
ms.votes$foote1851 <- ms.votes$V187/ms.votes$V190

ms.votes <- merge(ms.votes, countydata, by = "fips", all.x = TRUE, all.y = FALSE)

# lattice::xyplot(foote1851 ~ sprop1850, data = ms.votes, subset = state.abb %in% st.list , pch = 16, lwd = 4, col.line = "indianred", col = dodgerblue.30, xlab = "Proportion Slave, 1850", ylab = "Henry Foote Vote-share, 1851", panel =
#                     function(x,y,...) {  panel.xyplot(x, y, ...)
#                                          panel.smoother(x,y,method = "loess", col = "indianred", lwd = 4)})

#cairo_pdf(filename = "figs/ms-ga-1851-vote.pdf", family = "Minion Pro", height = 4.5, width = 9, pointsize = 11)
p1 <- lattice::xyplot(howell1851 ~ sprop1850, data = ga.votes, subset = state.abb %in% st.list , pch = 16, lwd = 4, ylim = c(0,1), col.line = "indianred", main = "Georgia Gubernatorial Election, 1851", col = dodgerblue.30, xlab = "Proportion Slave, 1850", ylab = "Howell Cobb Vote-share, 1851", panel =
                    function(x,y,...) {  panel.xyplot(x, y, ...)
                                         panel.smoother(x,y,method = "loess", col = "indianred", lwd = 4)})
p2 <- lattice::xyplot(foote1851 ~ sprop1850, data = ms.votes, subset = state.abb %in% st.list , pch = 16, lwd = 4, ylim = c(0,1), col.line = "indianred", main = "Mississippi Gubernatorial Election, 1851", col = dodgerblue.30, xlab = "Proportion Slave, 1850", ylab = "Henry Foote Vote-share, 1851", panel =
                    function(x,y,...) {  panel.xyplot(x, y, ...)
                                         panel.smoother(x,y,method = "loess", col = "indianred", lwd = 4)})
plot(p1, more = TRUE)
```
```{r echo = FALSE}
plot(p2)
```


### Figure 6. Correlation coefficients between parent’s white racial preference in 1965 and their children’s white racial preference measured at four time periods: 1965, 1973, 1982, and 1997.

Cannot be replicated by data on the Harvard Dataverse. Register and download *Three Generations Combined, 1965-1997 (ICPSR 4532)* [here](http://www.icpsr.umich.edu/icpsrweb/ICPSR/studies/4532) to replicate it.

### References